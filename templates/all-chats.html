{% extends 'base.html' %}
{% load static %}

{% block title %}
All Chats
{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/all-chats.css' %}">
<link rel="stylesheet" href="{% static 'css/chat-room.css' %}">
{% endblock extra_css %}

{% block body %}
<div class="chat-container">
  <!-- Left Sidebar - Chat List -->
  <div class="chat-sidebar">
    <!-- Navigation Bar -->
    <div class="chat-nav">
      <a href="?filter=all" class="nav-btn {% if request.GET.filter == 'all' or not request.GET.filter %}active{% endif %}">All</a>
      <a href="?filter=group" class="nav-btn {% if request.GET.filter == 'group' %}active{% endif %}">üë•</a>
      <a href="?filter=private" class="nav-btn {% if request.GET.filter == 'private' %}active{% endif %}">üë§</a>
      <a href="?filter=heart" class="nav-btn {% if request.GET.filter == 'heart' %}active{% endif %}">‚ô•Ô∏è</a>
    </div>

    <!-- Search Bar Section -->
    <div class="user-info">
      <div class="search-container">
        <form method="get" action="" class="search-form">
          <div class="search-wrapper">
            <span class="search-icon">üîç</span>
            <input type="text" name="search" class="chat-search-input" value="{{ request.GET.search }}" placeholder="Search chats or users...">
            {% if request.GET.search %}
            <a href="?" class="search-clear-btn" title="Clear search">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </a>
            {% endif %}
            {% if request.GET.filter %}
            <input type="hidden" name="filter" value="{{ request.GET.filter }}">
            {% endif %}
          </div>
        </form>
      </div>
    </div>

    <!-- Chat List -->
    <div class="chat-list-container">
      <div class="chat-list" id="chatList">
        {% for chat in chats %}
        <a href="?chat_id={{ chat.id }}" class="chat-item {% if selected_chat and selected_chat.id == chat.id %}active{% endif %}">
          <div class="chat-avatar">
            <div class="avatar-circle">
              {% if chat.user1 == request.user %}
                {{ chat.user2.username|first|upper }}
              {% else %}
                {{ chat.user1.username|first|upper }}
              {% endif %}
            </div>
          </div>

          <div class="chat-content">
            <div class="chat-header">
              <h5 class="chat-name">
                {% if chat.user1 == request.user %}
                  {{ chat.user2.username }}
                {% else %}
                  {{ chat.user1.username }}
                {% endif %}
              </h5>
            </div>

            <div class="chat-preview">
              {% with chat.messages.last as last_msg %}
                {% if last_msg %}
                  <p class="chat-message">{{ last_msg.text|truncatewords:10 }}</p>
                {% else %}
                  <p class="chat-message text-muted">No messages yet</p>
                {% endif %}
              {% endwith %}
            </div>
          </div>
        </a>
      {% empty %}
        <p class="text-muted p-3">No chats yet</p>
      {% endfor %}

      </div>
    </div>


  </div>

  <!-- Right Side - Chat Window -->
  <div class="chat-window">
    {% if selected_chat %}
      <!-- Chat Header -->
      <div class="chat-header">
        <div class="chat-user-info">
          <div class="chat-avatar">
            {{ other_user.username|first|upper }}
          </div>
          <div class="chat-user-details">
            <h3 class="chat-username">{{ other_user.username }}</h3>
            <span class="chat-status">Online</span>
          </div>
        </div>
        <div class="chat-header-actions">
          <button class="header-action-btn" title="More options">
            <span>‚ãØ</span>
          </button>
        </div>
      </div>

      <!-- Messages Area -->
      <div class="messages-container" id="messagesContainer">
        {% for message in selected_chat.messages.all %}
          <div class="message-wrapper {% if message.sender == request.user %}message-sent{% else %}message-received{% endif %}" data-message-id="{{ message.id }}">
            <div class="message-bubble">
              <p class="message-text">{{ message.text }}</p>
              <span class="message-time">{{ message.created_at|date:"H:i" }}</span>
            </div>
          </div>
        {% empty %}
          <div class="no-messages">
            <div class="no-messages-icon">üí¨</div>
            <p class="no-messages-text">No messages yet. Start the conversation!</p>
          </div>
        {% endfor %}
      </div>

      <!-- Message Input Area -->
      <div class="message-input-container">
        <form method="POST" action="?chat_id={{ selected_chat.id }}" class="message-form" id="messageForm">
          {% csrf_token %}
          <div class="input-wrapper">
            <input 
              type="text" 
              name="message" 
              class="message-input" 
              placeholder="Type a message..." 
              autocomplete="off"
              required
              id="messageInput"
            >
            <button type="submit" class="send-button" id="sendButton">
              <span class="send-icon">‚û§</span>
            </button>
          </div>
        </form>
      </div>
    {% else %}
      <!-- Placeholder when no chat is selected -->
      <div class="chat-window-placeholder">
        <div class="placeholder-content">
          <div class="placeholder-icon">üí¨</div>
          <h3>Select a chat to start messaging</h3>
          <p>Choose a conversation from the left sidebar to begin</p>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script>
  let lastMessageId = 0;
  let pollingInterval = null;
  let currentChatId = null;

  // Auto-scroll to bottom when page loads or chat changes
  function scrollToBottom() {
    const messagesContainer = document.getElementById('messagesContainer');
    if (messagesContainer) {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  }

  // Initialize lastMessageId from existing messages
  function initializeLastMessageId() {
    const messagesContainer = document.getElementById('messagesContainer');
    if (!messagesContainer) return;

    const messageWrappers = messagesContainer.querySelectorAll('.message-wrapper');
    if (messageWrappers.length > 0) {
      // Get the last message's ID from data attribute
      const lastWrapper = messageWrappers[messageWrappers.length - 1];
      const messageId = lastWrapper.getAttribute('data-message-id');
      if (messageId) {
        lastMessageId = parseInt(messageId, 10);
      }
    } else {
      lastMessageId = 0;
    }
  }

  // Function to append new message to the chat
  function appendMessage(msg) {
    const container = document.getElementById('messagesContainer');
    if (!container) return;

    // Remove "no messages" placeholder if it exists
    const noMessages = container.querySelector('.no-messages');
    if (noMessages) {
      noMessages.remove();
    }

    const wrapper = document.createElement('div');
    wrapper.className = msg.is_me
      ? 'message-wrapper message-sent'
      : 'message-wrapper message-received';
    wrapper.setAttribute('data-message-id', msg.id);

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';

    const text = document.createElement('p');
    text.className = 'message-text';
    text.textContent = msg.text;

    const time = document.createElement('span');
    time.className = 'message-time';
    time.textContent = msg.created_at;

    bubble.appendChild(text);
    bubble.appendChild(time);
    wrapper.appendChild(bubble);
    container.appendChild(wrapper);

    scrollToBottom();
    lastMessageId = msg.id;
  }

  // Poll for new messages
  function startPolling(chatId) {
    // Stop any existing polling
    if (pollingInterval) {
      clearInterval(pollingInterval);
      pollingInterval = null;
    }

    // Don't poll if no chat is selected
    if (!chatId) {
      return;
    }

    currentChatId = chatId;
    
    pollingInterval = setInterval(async () => {
      try {
        const response = await fetch(`/api/poll-messages/${chatId}/?last_id=${lastMessageId}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // Check if we got new messages
        if (data.messages && Array.isArray(data.messages) && data.messages.length > 0) {
          data.messages.forEach(msg => {
            appendMessage(msg);
          });
        }
      } catch (err) {
        console.error('Polling error:', err);
        // Don't spam errors, just log them
      }
    }, 2000); // Poll every 2 seconds
  }

  // Stop polling
  function stopPolling() {
    if (pollingInterval) {
      clearInterval(pollingInterval);
      pollingInterval = null;
    }
    currentChatId = null;
    lastMessageId = 0;
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    
    // Check if we have a selected chat
    {% if selected_chat %}
      initializeLastMessageId();
      startPolling({{ selected_chat.id }});
    {% endif %}
  });

  // Handle form submission
  const messageForm = document.getElementById('messageForm');
  if (messageForm) {
    messageForm.addEventListener('submit', function() {
      // Reset lastMessageId so we don't miss the message we just sent
      setTimeout(function() {
        scrollToBottom();
        // Re-initialize lastMessageId after page reloads
        {% if selected_chat %}
          initializeLastMessageId();
        {% endif %}
      }, 100);
    });
  }

  // Re-initialize when URL changes (chat selection changes)
  // This handles when user clicks on different chats
  let currentUrl = window.location.href;
  setInterval(function() {
    if (window.location.href !== currentUrl) {
      currentUrl = window.location.href;
      stopPolling();
      
      // Check if new chat is selected from URL
      const urlParams = new URLSearchParams(window.location.search);
      const newChatId = urlParams.get('chat_id');
      
      if (newChatId) {
        lastMessageId = 0;
        setTimeout(function() {
          initializeLastMessageId();
          startPolling(parseInt(newChatId, 10));
        }, 500);
      }
    }
  }, 1000);
</script>
{% endblock body %}
